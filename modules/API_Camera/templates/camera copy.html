<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络摄像头</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .video-photo-row {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            justify-content: center;
            width: 100%;
            gap: 32px;
        }

        #video {
            background-color: #000;
            min-height: 480px;
            min-width: 640px;
            object-fit: contain;
        }
    </style>
</head>

<body>

    <body>
        <div class="container">
            <h1>网络摄像头</h1>
            <div class="video-photo-row">
                <img id="video" src="/stream">
                <div style="position: relative; display: inline-block;">
                    <img id="snapshot" style="display:none; border:1px solid #ccc; max-width:320px;">
                    <button id="deleteSnapshotBtn"
                        style="display:none; position:absolute; top:5px; right:5px; z-index:2;"
                        class="btn btn-sm btn-danger">删除</button>
                </div>
            </div>
            <div class="mt-3">
                <button id="toggleBtn" class="btn btn-primary">开启相机</button>
                <button id="facetrackBtn" class="btn btn-success" disabled>开启人脸追踪</button>
                <button id="captureBtn" class="btn btn-primary">拍照</button>
            </div>
        </div>
        <script>
            let isCameraOn = true;
            let isFacetrackOn = false;

            const video = document.getElementById('video');
            const captureBtn = document.getElementById('captureBtn');
            const snapshot = document.getElementById('snapshot');
            const deleteSnapshotBtn = document.getElementById('deleteSnapshotBtn');
            const toggleBtn = document.getElementById('toggleBtn');
            const facetrackBtn = document.getElementById('facetrackBtn');

            // 初始化按钮状态
            function updateCameraBtn() {
                toggleBtn.textContent = isCameraOn ? '关闭相机' : '开启相机';
                toggleBtn.classList.toggle('btn-danger', isCameraOn);
                toggleBtn.classList.toggle('btn-primary', !isCameraOn);
                facetrackBtn.disabled = !isCameraOn;
            }

            function updateFacetrackBtn() {
                facetrackBtn.textContent = isFacetrackOn ? '关闭人脸追踪' : '开启人脸追踪';
                facetrackBtn.classList.toggle('btn-danger', isFacetrackOn);
                facetrackBtn.classList.toggle('btn-success', !isFacetrackOn);
            }

            // 页面加载时同步后端状态
            fetch('/status')
                .then(res => res.json())
                .then(status => {
                    isCameraOn = status.camera_on;
                    isFacetrackOn = status.face_tracking;
                    if (!isCameraOn) video.src = '';
                    updateCameraBtn();
                    updateFacetrackBtn();
                });

            // 相机开关按钮逻辑
            toggleBtn.onclick = function () {
                if (isCameraOn) {
                    fetch('/shutdown', { method: 'POST' })
                        .then(() => {
                            isCameraOn = false;
                            video.src = '';
                            updateCameraBtn();
                        });
                } else {
                    video.src = '/stream';
                    isCameraOn = true;
                    updateCameraBtn();
                }
            };

            captureBtn.onclick = function () {
                fetch('/capture')
                    .then(res => res.blob())
                    .then(blob => {
                        snapshot.src = URL.createObjectURL(blob);
                        snapshot.style.display = 'block';
                        deleteSnapshotBtn.style.display = 'block';
                    });
            };

            deleteSnapshotBtn.onclick = function () {
                snapshot.src = '';
                snapshot.style.display = 'none';
                deleteSnapshotBtn.style.display = 'none';
            };

            facetrackBtn.onclick = function () {
                fetch('/face_track', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ enable: !isFacetrackOn })
                }).then(() => {
                    isFacetrackOn = !isFacetrackOn;
                    updateFacetrackBtn();
                });
            };

            window.addEventListener('beforeunload', function () {
                navigator.sendBeacon('/shutdown');
            });
        </script>
    </body>

</html>